---
import BaseLayout from '../layouts/BaseLayout.astro';

const postModules = import.meta.glob('../pages/blog/*.{md,mdx}');
const posts = await Promise.all(
  Object.entries(postModules).map(async ([path, module]) => {
    const mod = await module();
    return {
      ...mod,
      url: path.replace('../pages', '').replace(/\.(md|mdx)$/, '')
    };
  })
);

function parseDate(dateString) {
  if (!dateString) return new Date(0);
  
  const match = dateString.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (match) {
    const [, year, month, day] = match;
    return new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
  }
  
  return new Date(dateString);
}

const sortedPosts = posts
  .filter(post => post.frontmatter.publishDate)
  .sort((a, b) => parseDate(b.frontmatter.publishDate).getTime() - parseDate(a.frontmatter.publishDate).getTime());

const postsByYear = sortedPosts.reduce((acc, post) => {
  const year = parseDate(post.frontmatter.publishDate).getFullYear();
  if (!acc[year]) {
    acc[year] = [];
  }
  acc[year].push(post);
  return acc;
}, {});

const years = Object.keys(postsByYear).sort((a, b) => b - a);
---

<BaseLayout title="Tech Notes - 技术博客">
  <div class="mb-8">
    <h1 class="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-1">技术博客</h1>
  </div>

  {years.map((year) => (
    <section class="mb-8">
      <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-3 border-b border-gray-200 dark:border-gray-700 pb-1">{year}</h2>
      <div class="space-y-3">
        {postsByYear[year].map((post) => {
          const publishDate = post.frontmatter.publishDate || '';
          const match = publishDate.match(/^(\d{4})-(\d{2})-(\d{2})$/);
          const displayDate = match ? `${match[2]}/${match[3]}` : publishDate;

          return (
            <article class="group hover:bg-gray-50 dark:hover:bg-gray-800 -mx-2 px-2 py-2 rounded transition-colors">
              <div style="display: flex; align-items: center; justify-content: space-between; gap: 1rem;">
                <div style="flex: 1; min-width: 0;">
                  <h3 style="margin: 0; font-size: 1rem; line-height: 1.5rem;">
                    <a
                      href={post.url}
                      class="text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 transition-colors group-hover:text-blue-600 dark:group-hover:text-blue-400"
                      style="display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"
                      title={post.frontmatter.title}
                    >
                      {post.frontmatter.title}
                    </a>
                  </h3>
                </div>
                <time style="color: #9ca3af; font-size: 0.75rem; font-family: ui-monospace, SFMono-Regular, 'SF Mono', Consolas, 'Liberation Mono', Menlo, monospace; flex-shrink: 0; font-variant-numeric: tabular-nums;">
                  {displayDate}
                </time>
              </div>
            </article>
          );
        })}
      </div>
    </section>
  ))}

  {sortedPosts.length === 0 && (
    <div class="text-center py-12">
      <p class="text-gray-500 dark:text-gray-400">暂无博客文章</p>
    </div>
  )}
</BaseLayout>